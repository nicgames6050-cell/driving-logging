<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Driving Logging</title>

  <!-- Manifest & PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#111111" />

  <!-- iOS Fullscreen -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Driving Logging">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <!-- Optional splash (generic) -->
  <link rel="apple-touch-startup-image" href="icons/splash.png">

  <style>
    :root {
      --bg: #121212;
      --panel: #1c1c1e;
      --text: #f2f2f7;
      --muted: #a1a1aa;
      --accent: #ef4444;
      --success: #22c55e;
      --input: #2a2a2e;
      --tabbar: #000;
    }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .app {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .header {
      padding: env(safe-area-inset-top) 16px 8px 16px;
      background: linear-gradient(180deg,#000,transparent);
      display: flex;
      align-items: flex-end;
      gap: 12px;
    }
    .logo {
      height: 28px;
      width: auto;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.35));
    }
    .title {
      font-weight: 700;
      letter-spacing: .3px;
    }
    .content {
      flex: 1;
      padding: 16px;
    }
    .card {
      background: var(--panel);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,.35);
    }
    label {
      display: block;
      font-size: 12px;
      letter-spacing: .2px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input[type="number"], input[type="text"], textarea {
      width: 100%;
      background: var(--input);
      border: 1px solid #2f2f33;
      border-radius: 12px;
      color: var(--text);
      padding: 12px 14px;
      font-size: 16px;
      outline: none;
    }
    textarea { min-height: 90px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .btn {
      -webkit-appearance: none;
      appearance: none;
      border: none;
      background: var(--accent);
      color: white;
      padding: 14px 16px;
      font-weight: 700;
      border-radius: 14px;
      width: 100%;
      font-size: 17px;
      box-shadow: 0 10px 20px rgba(239,68,68,.35);
    }
    .btn[disabled] { opacity: .6; }
    .status {
      margin-top: 10px;
      font-size: 14px;
      color: var(--muted);
    }
    /* Tabs */
    .tabbar {
      position: sticky;
      bottom: 0;
      background: var(--tabbar);
      border-top: 1px solid #1f1f1f;
      display: grid;
      grid-template-columns: 1fr 1fr;
      padding: 6px env(safe-area-inset-right) calc(6px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
      gap: 6px;
    }
    .tab {
      background: #0a0a0a;
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      opacity: .7;
    }
    .tab.active {
      background: var(--panel);
      opacity: 1;
      outline: 1px solid #2a2a2a;
    }
    iframe.sheet {
      width: 100%;
      height: calc(100vh - 160px);
      border: none;
      border-radius: 12px;
      background: #fff;
    }
    .hidden { display: none; }
    .spacer { height: 8px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <img class="logo" src="icons/apple-touch-icon.png" alt="Driving Logging" />
      <div class="title">Driving Logging</div>
    </div>

    <main class="content">
      <!-- Tab: Log Hours -->
      <section id="tab-log" class="tabpage">
        <div class="card">
          <div class="row">
            <div>
              <label for="minutes">Minutes Drove *</label>
              <input id="minutes" type="number" min="0" step="1" inputmode="numeric" placeholder="e.g., 45" required />
            </div>
            <div>
              <label for="notes">Additional Information (optional)</label>
              <textarea id="notes" placeholder="Trip details, route, conditions…"></textarea>
            </div>
            <button id="submit" class="btn">Save Drive</button>
            <div id="status" class="status"></div>
          </div>
        </div>
        <div class="spacer"></div>
        <div class="card">
          <div style="font-size:12px;color:var(--muted)">
            Submissions are saved to Google Forms silently. Date is auto-filled. Notes default to “None” if left blank.
          </div>
        </div>
      </section>

      <!-- Tab: View Records -->
      <section id="tab-view" class="tabpage hidden">
        <div class="card" style="padding:0">
          <iframe class="sheet" src="https://docs.google.com/spreadsheets/d/1mWv9qLkjmtTP-yIKymjmBvF6-MkuuA1xALk7M6ycGJM/edit?usp=sharing"></iframe>
        </div>
      </section>
    </main>

    <nav class="tabbar">
      <div id="tabbtn-log" class="tab active">Log Hours</div>
      <div id="tabbtn-view" class="tab">View Records</div>
    </nav>
  </div>

  <script>
    // Register service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js');
      });
    }

    // Tabs
    const pages = {
      log: document.getElementById('tab-log'),
      view: document.getElementById('tab-view'),
    };
    const tabbtnLog = document.getElementById('tabbtn-log');
    const tabbtnView = document.getElementById('tabbtn-view');

    function showTab(which) {
      pages.log.classList.toggle('hidden', which !== 'log');
      pages.view.classList.toggle('hidden', which !== 'view');
      tabbtnLog.classList.toggle('active', which === 'log');
      tabbtnView.classList.toggle('active', which === 'view');
      if (which === 'view') {
        // blur form inputs to feel native
        document.activeElement && document.activeElement.blur && document.activeElement.blur();
      }
      localStorage.setItem('activeTab', which);
    }
    tabbtnLog.addEventListener('click', () => showTab('log'));
    tabbtnView.addEventListener('click', () => showTab('view'));
    showTab(localStorage.getItem('activeTab') || 'log');

    // Form handling (silent submit to Google Forms)
    const formEndpoint = "https://docs.google.com/forms/d/e/1FAIpQLSfvuNMRbaeXYqDSNTkBfAbERwwMzvGctfVkzBu6lLJrZbV5WA/formResponse";
    const ENTRY_TIME = "entry.2022091739"; // Time-Driving
    const ENTRY_DATE = "entry.558305075";  // Driving-Date (text field)
    const ENTRY_NOTES = "entry.1084333853"; // Additional-Notes

    function todayString() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`; // ISO-like; works fine for text field
    }

    const minutesEl = document.getElementById('minutes');
    const notesEl = document.getElementById('notes');
    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submit');

    function setStatus(text, ok=false) {
      statusEl.textContent = text;
      statusEl.style.color = ok ? getComputedStyle(document.documentElement).getPropertyValue('--success') : 'var(--muted)';
    }

    async function submitSilent() {
      const mins = (minutesEl.value || '').trim();
      if (!mins) {
        minutesEl.focus();
        setStatus('Enter minutes to save.');
        return;
      }
      submitBtn.disabled = true;
      setStatus('Saving…');

      const data = new URLSearchParams();
      data.append(ENTRY_TIME, mins);
      data.append(ENTRY_DATE, todayString());
      data.append(ENTRY_NOTES, (notesEl.value || 'None').trim() || 'None');

      try {
        await fetch(formEndpoint, {
          method: 'POST',
          mode: 'no-cors', // Google Forms blocks CORS; "opaque" response expected
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: data.toString()
        });
        setStatus('Saved ✓', true);
        minutesEl.value = '';
        notesEl.value = '';
        // optional: switch to records tab
        // showTab('view');
      } catch (e) {
        setStatus('Could not save. Check connection and try again.');
        console.error(e);
      } finally {
        submitBtn.disabled = false;
      }
    }

    submitBtn.addEventListener('click', submitSilent);
    // Submit on Enter in minutes field
    minutesEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') submitSilent();
    });
  </script>
</body>
</html>
